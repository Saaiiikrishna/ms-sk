spring:
  application:
    name: payment-service
  datasource:
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:paymentdb} # Default DB name changed
    username: ${DB_USER:paymentuser}
    password: ${DB_PASS:paymentpass}
    driver-class-name: org.postgresql.Driver
  jpa:
    hibernate:
      ddl-auto: validate
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: false # Keep false unless debugging
    show-sql: false

flyway:
  enabled: true
  baseline-on-migrate: true

kafka:
  bootstrap-servers: ${KAFKA_BROKER:localhost:9092}
  consumer:
    group-id: payment-service-group # Changed group-id
    key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
    value-deserializer: io.confluent.kafka.serializers.KafkaAvroDeserializer
    properties:
      specific.avro.reader: true
      schema.registry.url: ${SCHEMA_REGISTRY_URL:http://localhost:8081}
      # auto.offset.reset: earliest # Or latest, depending on requirements
    enable-auto-commit: false # Manual ack in listener
  producer:
    key-serializer: org.apache.kafka.common.serialization.StringSerializer
    value-serializer: io.confluent.kafka.serializers.KafkaAvroSerializer
    properties:
      schema.registry.url: ${SCHEMA_REGISTRY_URL:http://localhost:8081}
      # acks: all # For better durability
  topics:
    paymentRequested: order.payment.requested # Consumed by this service
    paymentSucceeded: order.payment.succeeded # Produced by this service
    paymentFailed: order.payment.failed     # Produced by this service
    refundRequested: order.refund.requested   # Consumed by this service (if handling refunds)
    refundSucceeded: order.refund.succeeded # Produced by this service (if handling refunds)
    # Vendor Payout Topics
    vendorPayoutInitiated: vendor.payout.initiated
    vendorPayoutSucceeded: vendor.payout.succeeded
    vendorPayoutFailed:    vendor.payout.failed
    # Webhook related events might also be published to internal topics if needed
    # e.g., razorpay.payment.authorized, razorpay.payment.failed

management:
  endpoints:
    web:
      exposure:
        include: health,metrics,info,prometheus
  endpoint:
    health:
      show-details: when_authorized
      # Consider specific health indicators for Razorpay connectivity, DB, Kafka

# Keycloak (if webhook or other endpoints need security)
# keycloak:
#   enabled: true # False by default if not immediately needed
#   realm: ${KEYCLOAK_REALM:myrealm}
#   auth-server-url: ${KEYCLOAK_URL:http://localhost:8080}/auth
#   resource: ${KEYCLOAK_CLIENT_ID:payment-service-client}
#   credentials:
#     secret: ${KEYCLOAK_CLIENT_SECRET:} # From environment or K8s secret

server:
  port: 8083 # Different port for payment-service

logging:
  level:
    root: INFO
    com.mysillydreams.payment: DEBUG # Changed package name
    org.springframework.kafka: INFO
    com.razorpay: INFO # Razorpay SDK logging level

# Payment Service specific properties
payment:
  outbox:
    poll:
      delay: ${PAYMENT_OUTBOX_POLL_DELAY:5000} # ms, make configurable via env
      initialDelay: ${PAYMENT_OUTBOX_POLL_INITIALDELAY:10000} # ms
  # Razorpay Configuration - these will be primary source if @Value uses them
  razorpay:
    key-id: ${RAZORPAY_KEY_ID} # Mandatory: Get from environment or K8s secret
    key-secret: ${RAZORPAY_KEY_SECRET} # Mandatory: Get from environment or K8s secret
    webhook:
      secret: ${RAZORPAY_WEBHOOK_SECRET} # Mandatory for webhook validation
      # enabled: true # If webhooks are actively used
    payout:
      account-id: ${RAZORPAY_X_ACCOUNT_ID} # Mandatory: Your RazorpayX account ID from which payouts are made
  commission:
    percent: ${APP_COMMISSION_PERCENT:10.0} # Default to 10%, configurable via env var

# Resilience4j circuit breaker example config (if used)
resilience4j:
  circuitbreaker:
    instances:
      razorpayOrdersApi: # For Razorpay Order related calls
        registerHealthIndicator: true
        slidingWindowType: COUNT_BASED
        slidingWindowSize: 10 # Last 10 calls
        minimumNumberOfCalls: 5 # Minimum calls before CB calculates error rate
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 10s # Wait 10s before transitioning to half-open
        failureRateThreshold: 60 # If 60% of calls fail, open circuit
        eventConsumerBufferSize: 100 # Increased buffer size
        recordExceptions:
          - com.razorpay.RazorpayException # Record all Razorpay exceptions
          - java.io.IOException
          - java.util.concurrent.TimeoutException
        ignoreExceptions: # Exceptions that should not count as failures
          - com.razorpay.BadRequestException # e.g. 4xx errors from client mistakes
          # Add other specific client-side error exceptions from Razorpay if identifiable
      razorpayPaymentsApi: # For Razorpay Payment related calls (capture, fetch)
        # Similar configuration as razorpayOrdersApi, can be tuned differently
        registerHealthIndicator: true
        slidingWindowType: COUNT_BASED
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        waitDurationInOpenState: 10s
        failureRateThreshold: 60
        eventConsumerBufferSize: 100 # Added buffer size
        recordExceptions: [com.razorpay.RazorpayException, java.io.IOException]
        ignoreExceptions: [com.razorpay.BadRequestException]
      razorpayPayoutsApi: # For Razorpay Payouts.create calls
        registerHealthIndicator: true
        slidingWindowType: COUNT_BASED
        slidingWindowSize: 8
        minimumNumberOfCalls: 4
        permittedNumberOfCallsInHalfOpenState: 2
        waitDurationInOpenState: 15s # Payouts might be more critical or have different characteristics
        failureRateThreshold: 50
        eventConsumerBufferSize: 100 # Added buffer size
        recordExceptions: [com.razorpay.RazorpayException, java.io.IOException]
        ignoreExceptions: [com.razorpay.BadRequestException]

  retry:
    instances:
      razorpayApiRetry: # A general retry policy for Razorpay calls
        maxAttempts: 3
        waitDuration: 200ms # Initial wait duration
        retryExceptions: # Exceptions that trigger a retry
          - com.razorpay.RazorpayException # Retry on general Razorpay server-side issues
          - java.io.IOException
          - java.util.concurrent.TimeoutException
          # Be careful not to retry on BadRequestException or similar client errors unless appropriate
        ignoreExceptions: # Exceptions that should NOT trigger a retry
          - com.razorpay.BadRequestException
          # Add specific non-retryable Razorpay exceptions if documented
        # For exponential backoff:
        # enableExponentialBackoff: true
        # exponentialBackoffMultiplier: 2
        # maxWaitDuration: 2s # Optional max wait if using exponential backoff

  # TimeLimiter can be used if @Async methods need external timeouts,
  # but Razorpay SDK might have its own HTTP client timeouts.
  # For synchronous calls wrapped in CB/Retry, usually not combined with TimeLimiter directly on the method.
  # timelimiter:
  #   instances:
  #     razorpayTimeLimiter:
  #       timeoutDuration: 3s # Max duration for a call
  #       cancelRunningFuture: true
